<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Python学习之路-爬虫提高:框架功能完善 - Silence Blog</title><meta name="Description" content="Silence‘s blog"><meta property="og:title" content="Python学习之路-爬虫提高:框架功能完善" />
<meta property="og:description" content="完善框架的基础功能 项目中除了实现main.py以外，还需要实现： 项目配置文件 爬虫文件 管道文件 中间件文件 框架中还需要实现： 框架配置文件，并且需" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" />
<meta property="og:image" content="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"/>
<meta property="article:published_time" content="2021-06-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-06-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"/>

<meta name="twitter:title" content="Python学习之路-爬虫提高:框架功能完善"/>
<meta name="twitter:description" content="完善框架的基础功能 项目中除了实现main.py以外，还需要实现： 项目配置文件 爬虫文件 管道文件 中间件文件 框架中还需要实现： 框架配置文件，并且需"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" /><link rel="prev" href="https://silencehuliang.github.io/%E4%B8%80%E4%B8%AApython%E5%BC%80%E5%8F%91%E8%80%85%E5%AF%B9%E9%B8%BF%E8%92%99%E7%9A%84%E7%9C%8B%E6%B3%95/" /><link rel="next" href="https://silencehuliang.github.io/%E6%AF%8F%E5%A4%A9%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84python%E5%BA%93-chardet/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.2e7125082ec8de83a87adc70253c9c23.css" integrity="md5-LnElCC7I3oOoetxwJTycIw=="><link rel="stylesheet" href="/css/style.min.f03a2ec71b16efbe4f24352e542c93a9.css" integrity="md5-8DouxxsW775PJDUuVCyTqQ=="><link rel="stylesheet" href="/lib/fontawesome-free/all.min.76cb46c10b6c0293433b371bae2414b2.css" integrity="md5-dstGwQtsApNDOzcbriQUsg=="><link rel="stylesheet" href="/lib/animate/animate.min.bc1a6a99c43f5ccc97d2d350bde13f74.css" integrity="md5-vBpqmcQ/XMyX0tNQveE/dA=="><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Python学习之路-爬虫提高:框架功能完善",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/silencehuliang.github.io\/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84\/"
        },"genre": "posts","keywords": "Python学习之路","wordcount":  14758 ,
        "url": "https:\/\/silencehuliang.github.io\/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84\/","datePublished": "2021-06-12T00:00:00+00:00","dateModified": "2021-06-13T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Silence"},"author": {
                "@type": "Person",
                "name": "Silence"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Silence Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg, https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg 1.5x, https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"
        title="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Silence Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg, https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg 1.5x, https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg"
        title="https://tva1.sinaimg.cn/large/00729CCqgy1gp1qfrpi14j305k05k745.jpg" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Python学习之路-爬虫提高:框架功能完善</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Silence</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E7%88%AC%E8%99%AB/"><i class="far fa-folder fa-fw"></i>爬虫</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-06-12">2021-06-12</time>&nbsp;<i class="fa fa-history" aria-hidden="true"></i>
                2021-06-13
                <i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 14758 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 30 分钟&nbsp;<span id="/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" class="leancloud_visitors" data-flag-title="Python学习之路-爬虫提高:框架功能完善">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#完善框架的基础功能">完善框架的基础功能</a></li>
    <li><a href="#日志模块的使用">日志模块的使用</a>
      <ul>
        <li><a href="#为什么要使用添加日志功能">为什么要使用添加日志功能</a></li>
        <li><a href="#日志模块简单使用">日志模块简单使用</a></li>
        <li><a href="#利用logger封装日志模块">利用logger封装日志模块</a></li>
        <li><a href="#在框架中使用日志模块">在框架中使用日志模块</a></li>
      </ul>
    </li>
    <li><a href="#框架中实现配置文件">框架中实现配置文件</a>
      <ul>
        <li><a href="#实现框架的默认配置文件">实现框架的默认配置文件</a></li>
        <li><a href="#在框架中使用">在框架中使用</a></li>
        <li><a href="#创建项目配置文件并实现修改框架默认配置文件属性">创建项目配置文件，并实现修改框架默认配置文件属性</a></li>
      </ul>
    </li>
    <li><a href="#多爬虫实现">多爬虫实现</a>
      <ul>
        <li><a href="#多请求实现">多请求实现</a>
          <ul>
            <li><a href="#需求分析">需求分析</a></li>
            <li><a href="#项目中实现爬虫文件">项目中实现爬虫文件</a></li>
          </ul>
        </li>
        <li><a href="#实现发起多个请求">实现发起多个请求</a>
          <ul>
            <li><a href="#修改框架的爬虫组件文件-spiderpy">修改框架的爬虫组件文件 <code>spider.py</code>:</a></li>
            <li><a href="#修改引擎-enginepy">修改引擎 <code>engine.py</code></a></li>
            <li><a href="#修改调度器-schedulerpy">修改调度器 <code>scheduler.py</code>：</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#爬虫实现多个解析函数">爬虫实现多个解析函数</a>
      <ul>
        <li><a href="#响应对象的解析方法封装">响应对象的解析方法封装</a></li>
        <li><a href="#实现多个解析函数">实现多个解析函数</a></li>
        <li><a href="#在引擎中需要动态的判断和获取对应的解析函数">在引擎中需要动态的判断和获取对应的解析函数</a></li>
      </ul>
    </li>
    <li><a href="#多爬虫文件">多爬虫文件</a>
      <ul>
        <li><a href="#为什么需要优化现有的爬虫结构">为什么需要优化现有的爬虫结构</a></li>
        <li><a href="#同时执行多个不同的爬虫">同时执行多个不同的爬虫</a></li>
      </ul>
    </li>
    <li><a href="#实现多个管道">实现多个管道</a>
      <ul>
        <li><a href="#为什么需要多个管道">为什么需要多个管道</a></li>
        <li><a href="#项目文件夹中实现管道文件">项目文件夹中实现管道文件</a></li>
        <li><a href="#修改引擎的代码">修改引擎的代码</a></li>
        <li><a href="#修改mainpy">修改<code>main.py</code></a></li>
      </ul>
    </li>
    <li><a href="#实现项目中传入多个中间件">实现项目中传入多个中间件</a>
      <ul>
        <li><a href="#为什么需要多个中间件">为什么需要多个中间件</a></li>
        <li><a href="#在项目文件夹中创建middlewares文件">在项目文件夹中创建middlewares文件</a></li>
        <li><a href="#修改项目文件夹中的mainpy">修改项目文件夹中的<code>main.py</code></a></li>
        <li><a href="#因此相应的的修改enginepy">因此相应的的修改<code>engine.py</code></a></li>
      </ul>
    </li>
    <li><a href="#动态导入模块">动态导入模块</a>
      <ul>
        <li><a href="#目前代码存在的问题">目前代码存在的问题</a></li>
        <li><a href="#模块动态导入的方法">模块动态导入的方法</a></li>
        <li><a href="#在settings中设置spidermiddlewares">在settings中设置SPIDER，MIDDLEWARES</a></li>
        <li><a href="#修改mainpy-1">修改<code>main.py</code></a></li>
      </ul>
    </li>
    <li><a href="#去重原理">去重原理</a>
      <ul>
        <li><a href="#去重的理解">去重的理解</a></li>
        <li><a href="#爬虫请求去重原理和实现">爬虫请求去重原理和实现</a></li>
        <li><a href="#修改engine模块">修改engine模块</a></li>
      </ul>
    </li>
    <li><a href="#利用线程池实现异步">利用线程池实现异步</a>
      <ul>
        <li><a href="#异步任务分析">异步任务分析：</a></li>
        <li><a href="#利用回调实现循环">利用回调实现循环</a></li>
        <li><a href="#实现异步并发控制">实现异步并发控制</a></li>
        <li><a href="#对异步任务进行异常控制增加异常回调函数error_callback">对异步任务进行异常控制，增加异常回调函数error_callback</a></li>
      </ul>
    </li>
    <li><a href="#使用gevent的pool实现异步并发">使用gevent的Pool实现异步并发</a>
      <ul>
        <li><a href="#为什么使用gevent">为什么使用gevent</a></li>
        <li><a href="#通过配置文件设置属性来判断所使用的异步方式">通过配置文件设置属性，来判断所使用的异步方式</a></li>
        <li><a href="#让gevent的pool和线程池pool的接口一致">让gevent的Pool和线程池Pool的接口一致</a></li>
        <li><a href="#在引擎中使用上">在引擎中使用上：</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="完善框架的基础功能">完善框架的基础功能</h2>
<p><code>项目</code>中除了实现main.py以外，还需要实现：</p>
<ul>
<li>项目配置文件</li>
<li>爬虫文件</li>
<li>管道文件</li>
<li>中间件文件</li>
</ul>
<p><code>框架</code>中还需要实现：</p>
<ul>
<li>框架配置文件，并且需要实现导入项目配置文件，同时覆盖默认配置文件的属性</li>
<li>支持多个爬虫的传入以及使用</li>
<li>支持多个管道的传入以及使用</li>
<li>支持多个中间件的传入以及使用</li>
</ul>
<h2 id="日志模块的使用">日志模块的使用</h2>
<h3 id="为什么要使用添加日志功能">为什么要使用添加日志功能</h3>
<ol>
<li>能够方便的对程序进行调试</li>
<li>能够记录程序的运行状态，包括错误</li>
</ol>
<h3 id="日志模块简单使用">日志模块简单使用</h3>
<ul>
<li>日志的等级</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># 日志的五个等级，等级依次递增</span>
<span class="c1"># 默认是WARNING等级</span>
<span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
<span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
<span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>
<span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
<span class="c1"># 设置日志等级</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="c1"># 使用</span>
<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>捕获异常信息到日志。这里主要需要进行捕获异常才能记录下完整的异常信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="k">try</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;异常&#34;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>日志的输出格式 对于日志的输出格式，我们能够进行自定义，包括输出的<code>内容格式</code>和<code>时间格式</code></li>
</ul>
<p>format格式说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-txt" data-lang="txt">      %(name)s  Logger的名字
      %(levelno)s 数字形式的日志级别
      %(levelname)s 文本形式的日志级别
      %(pathname)s 调用日志输出函数的模块的完整路径名，可能没有
      %(filename)s 调用日志输出函数的模块的文件名
      %(module)s 调用日志输出函数的模块名
      %(funcName)s 调用日志输出函数的函数名
      %(lineno)d 调用日志输出函数的语句所在的代码行
      %(created)f 当前时间，用UNIX标准的表示时间的浮 点数表示
      %(relativeCreated)d 输出日志信息时的，自Logger创建以 来的毫秒数
      %(asctime)s 字符串形式的当前时间。默认格式是 “2003-07-08 16:49:45,896”。逗号后面的是毫秒
      %(thread)d 线程ID。可能没有
      %(threadName)s 线程名。可能没有
      %(process)d 进程ID。可能没有
      %(message)s 用户输出的消息
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>datefmt参数说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">%y 两位数的年份表示（00-99）
%Y 四位数的年份表示（000-9999）
%m 月份（01-12）
%d 月内中的一天（0-31）
%H 24小时制小时数（0-23）
%I 12小时制小时数（01-12）
%M 分钟数（00=59）
%S 秒（00-59）
%a 本地简化星期名称
%A 本地完整星期名称
%b 本地简化的月份名称
%B 本地完整的月份名称
%c 本地相应的日期表示和时间表示
%j 年内的一天（001-366）
%p 本地A.M.或P.M.的等价符
%U 一年中的星期数（00-53）星期天为星期的开始
%w 星期（0-6），星期天为星期的开始
%W 一年中的星期数（00-53）星期一为星期的开始
%x 本地相应的日期表示
%X 本地相应的时间表示
%Z 当前时区的名称
%% %号本身
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="利用logger封装日志模块">利用logger封装日志模块</h3>
<p>在scrapy_plus目录下建立utils包 (utility：工具)，专门放置工具类型模块，如日志模块<code>log.py</code> 下面的代码内容是固定的，在任何地方都可以使用下面的代码实习日志内容的输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/utils/log.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># 默认的配置</span>
<span class="n">DEFAULT_LOG_LEVEL</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>    <span class="c1"># 默认等级</span>
<span class="n">DEFAULT_LOG_FMT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(filename)s</span><span class="s1"> [line:</span><span class="si">%(lineno)d</span><span class="s1">] </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>   <span class="c1"># 默认日志格式</span>
<span class="n">DEFUALT_LOG_DATEFMT</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>  <span class="c1"># 默认时间格式</span>
<span class="n">DEFAULT_LOG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;log.log&#39;</span>    <span class="c1"># 默认日志文件名称</span>


<span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. 获取一个logger对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># 2. 设置format对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_LOG_FMT</span><span class="p">,</span><span class="n">datefmt</span><span class="o">=</span><span class="n">DEFUALT_LOG_DATEFMT</span><span class="p">)</span>
        <span class="c1"># 3. 设置日志输出</span>
        <span class="c1"># 3.1 设置文件日志模式</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_file_handler</span><span class="p">(</span><span class="n">DEFAULT_LOG_FILENAME</span><span class="p">))</span>
        <span class="c1"># 3.2 设置终端日志模式</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_console_handler</span><span class="p">())</span>
        <span class="c1"># 4. 设置日志等级</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">DEFAULT_LOG_LEVEL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_file_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;返回一个文件日志handler&#39;&#39;&#39;</span>
        <span class="c1"># 1. 获取一个文件日志handler</span>
        <span class="n">filehandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
        <span class="c1"># 2. 设置日志格式</span>
        <span class="n">filehandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
        <span class="c1"># 3. 返回</span>
        <span class="k">return</span> <span class="n">filehandler</span>

    <span class="k">def</span> <span class="nf">_get_console_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;返回一个输出到终端日志handler&#39;&#39;&#39;</span>
        <span class="c1"># 1. 获取一个输出到终端日志handler</span>
        <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="c1"># 2. 设置日志格式</span>
        <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
        <span class="c1"># 3. 返回handler</span>
        <span class="k">return</span> <span class="n">console_handler</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

<span class="c1"># 初始化并配一个logger对象，达到单例的</span>
<span class="c1"># 使用时，直接导入logger就可以使用</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span><span class="o">.</span><span class="n">logger</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="在框架中使用日志模块">在框架中使用日志模块</h3>
<p>使用参考</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">scrapy_plus.http.request</span> <span class="kn">import</span> <span class="n">Request</span>    <span class="c1"># 导入Request对象</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.middlewares.spider_middlewares</span> <span class="kn">import</span> <span class="n">SpiderMiddleware</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.middlewares.downloader_middlewares</span> <span class="kn">import</span> <span class="n">DownloaderMiddleware</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.log</span> <span class="kn">import</span> <span class="n">logger</span>    <span class="c1"># 导入logger</span>

<span class="kn">from</span> <span class="nn">.spider</span> <span class="kn">import</span> <span class="n">Spider</span>
<span class="kn">from</span> <span class="nn">.scheduler</span> <span class="kn">import</span> <span class="n">Scheduler</span>
<span class="kn">from</span> <span class="nn">.downloader</span> <span class="kn">import</span> <span class="n">Downloader</span>
<span class="kn">from</span> <span class="nn">.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>


<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">......</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;启动整个引擎&#39;&#39;&#39;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="c1"># 起始时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;开始运行时间：</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">start</span><span class="p">)</span>  <span class="c1"># 使用日志记录起始运行时间</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_engine</span><span class="p">()</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="c1"># 结束时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;开始运行时间：</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">stop</span><span class="p">)</span>  <span class="c1"># 使用日志记录结束运行时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;耗时：</span><span class="si">%.2f</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>  <span class="c1"># 使用日志记录运行耗时</span>

<span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="框架中实现配置文件">框架中实现配置文件</h2>
<h3 id="实现框架的默认配置文件">实现框架的默认配置文件</h3>
<p>在scrapy_plus下建立conf包文件夹在它下面建立default_settings.py：设置默认配置的配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># 默认的日志配置</span>
<span class="n">DEFAULT_LOG_LEVEL</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>    <span class="c1"># 默认等级</span>
<span class="n">DEFAULT_LOG_FMT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(filename)s</span><span class="s1">[line:</span><span class="si">%(lineno)d</span><span class="s1">] </span><span class="se">\
</span><span class="se"></span><span class="s1">                  </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>   <span class="c1"># 默认日志格式</span>
<span class="n">DEFUALT_LOG_DATEFMT</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>  <span class="c1"># 默认时间格式</span>
<span class="n">DEFAULT_LOG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;log.log&#39;</span>    <span class="c1"># 默认日志文件名称</span>
</code></pre></td></tr></table>
</div>
</div><p>再在conf下创建settings.py文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/conf/settings</span>
<span class="kn">from</span> <span class="nn">.default_settings</span> <span class="kn">import</span> <span class="o">*</span>    <span class="c1"># 全部导入默认配置文件的属性</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="在框架中使用">在框架中使用</h3>
<p>利用框架配置文件改写<code>log.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/utils/log.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">scrapy_plus.conf</span> <span class="kn">import</span> <span class="n">settings</span>    <span class="c1"># 导入框架的settings文件</span>


<span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. 获取一个logger对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># 2. 设置format对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_LOG_FMT</span><span class="p">,</span><span class="n">datefmt</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFUALT_LOG_DATEFMT</span><span class="p">)</span>
        <span class="c1"># 3. 设置日志输出</span>
        <span class="c1"># 3.1 设置文件日志模式</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_file_handler</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_LOG_FILENAME</span><span class="p">))</span>
        <span class="c1"># 3.2 设置终端日志模式</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_console_handler</span><span class="p">())</span>
        <span class="c1"># 4. 设置日志等级</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_LOG_LEVEL</span><span class="p">)</span>

<span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="创建项目配置文件并实现修改框架默认配置文件属性">创建项目配置文件，并实现修改框架默认配置文件属性</h3>
<p>项目文件夹下创建项目配置文件<code>settings.py</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># project_dir/settings.py</span>
<span class="c1"># 修改默认日志文件名称</span>
<span class="n">DEFAULT_LOG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;日志.log&#39;</span>    <span class="c1"># 默认日志文件名称</span>
</code></pre></td></tr></table>
</div>
</div><p>修改框架的settings.py文件，实现修改默认配置文件属性的目的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/conf/settings</span>
<span class="kn">from</span> <span class="nn">.default_settings</span> <span class="kn">import</span> <span class="o">*</span>    <span class="c1"># 全部导入默认配置文件的属性</span>
<span class="c1"># 这里导入的settings，是项目文件夹的settings文件</span>
<span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="o">*</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="多爬虫实现">多爬虫实现</h2>
<h3 id="多请求实现">多请求实现</h3>
<h4 id="需求分析">需求分析</h4>
<p>在发送关于start_url中的请求的时候，往往我们的请求并不是只有一个，而且在解析了响应之后，可能需要继续构造请求并且发送，那么对应的需要在引擎中进行修改。</p>
<h4 id="项目中实现爬虫文件">项目中实现爬虫文件</h4>
<ul>
<li>
<p>在main.py同级目录下建立<code>spiders.py</code>，存放定义的爬虫类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">  <span class="c1"># project_dir/spiders.py</span>
  <span class="kn">from</span> <span class="nn">scrapy_plus.core.spider</span> <span class="kn">import</span> <span class="n">Spider</span>
  
  <span class="c1"># 继承框架的爬虫基类</span>
  <span class="k">class</span> <span class="nc">BaiduSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
  
      <span class="n">start_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.baidu.com&#39;</span>    <span class="c1"># 设置初始请求url</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改<code>main.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">  <span class="c1"># project_dir/main.py</span>
  <span class="kn">from</span> <span class="nn">scrapy_plus.core.engine</span> <span class="kn">import</span> <span class="n">Engine</span>    <span class="c1"># 导入引擎</span>
  
  <span class="kn">from</span> <span class="nn">spiders</span> <span class="kn">import</span> <span class="n">BaiduSpider</span>
  
  <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">spider</span> <span class="o">=</span> <span class="n">BaiduSpider</span><span class="p">()</span>    <span class="c1"># 实例化爬虫对象</span>
      <span class="n">engine</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">(</span><span class="n">spider</span><span class="p">)</span>    <span class="c1"># 传入爬虫对象</span>
      <span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="c1"># 启动引擎</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改<code>engine.py</code>，设置为接收外部传入的爬虫对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">  <span class="c1"># scrapy_plus/core/engine.py</span>
  <span class="o">...</span>
  <span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
      <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>    <span class="c1"># 接收外部传入的爬虫对象</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">spider</span> <span class="o">=</span> <span class="n">spider</span>    <span class="c1"># 爬虫对象</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>    <span class="c1"># 初始化调度器对象</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>    <span class="c1"># 初始化下载器对象</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>    <span class="c1"># 初始化管道对象</span>
  
          <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span> <span class="o">=</span> <span class="n">SpiderMiddleware</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span> <span class="o">=</span> <span class="n">DownloaderMiddleware</span><span class="p">()</span>
  <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="实现发起多个请求">实现发起多个请求</h3>
<h4 id="修改框架的爬虫组件文件-spiderpy">修改框架的爬虫组件文件 <code>spider.py</code>:</h4>
<ul>
<li>设置为初始请求url为多个</li>
<li>修改start_requests方法，将返回多个请求对象</li>
<li>利用生成器方式实现start_requests，提高程序的资源消耗</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># scrapy_plus/core/spider.py</span>
<span class="s1">&#39;&#39;&#39;爬虫组件封装&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.item</span> <span class="kn">import</span> <span class="n">Item</span>    <span class="c1"># 导入Item对象</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.http.request</span> <span class="kn">import</span> <span class="n">Request</span>    <span class="c1"># 导入Request对象</span>


<span class="k">class</span> <span class="nc">Spider</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    1. 构建请求信息(初始的)，也就是生成请求对象(Request)
</span><span class="s1">    2. 解析响应对象，返回数据对象(Item)或者新的请求对象(Request)
</span><span class="s1">    &#39;&#39;&#39;</span>

    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># 默认初始请求地址</span>

    <span class="c1"># def start_requests(self):</span>
    <span class="c1">#     &#39;&#39;&#39;构建初始请求对象并返回&#39;&#39;&#39;</span>
    <span class="c1">#     request_list = []</span>
    <span class="c1">#     for url in self.start_urls:</span>
    <span class="c1">#         request_list.append(Request(url))</span>
    <span class="c1">#     return request_list</span>

    <span class="c1"># 利用生成器方式实现，提高程序的资源消耗</span>
    <span class="k">def</span> <span class="nf">start_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;构建初始请求对象并返回&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_urls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;解析请求
</span><span class="s1">        并返回新的请求对象、或者数据对象
</span><span class="s1">        返回值应当是一个容器，如start_requests返回值方法一样，改为生成器即可
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">yield</span> <span class="n">Item</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>   <span class="c1"># 返回item对象 改为生成器即可</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="修改引擎-enginepy">修改引擎 <code>engine.py</code></h4>
<ul>
<li>将代码拆分为两个方法，便于维护，提高代码可读性</li>
<li>统计总共完成的响应数</li>
<li>设置程序退出条件：当总响应数等于总请求数时，退出</li>
<li>实现处理start_requests方法返回多个请求的功能</li>
<li>实现处理parse解析函数返回多个对象的功能</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># scheduler/core/engine.py</span>
<span class="s1">&#39;&#39;&#39;引擎
</span><span class="s1">a. 对外提供整个的程序的入口
</span><span class="s1">b. 依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">.downloader</span> <span class="kn">import</span> <span class="n">Downloader</span>
<span class="kn">from</span> <span class="nn">.pipeline</span> <span class="kn">import</span>  <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">.scheduler</span> <span class="kn">import</span>  <span class="n">Scheduler</span>
<span class="kn">from</span> <span class="nn">.spider</span> <span class="kn">import</span> <span class="n">Spider</span>

<span class="kn">from</span> <span class="nn">scrapy_plus.http.request</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.middlewares.downloader_middlewares</span> <span class="kn">import</span> <span class="n">DownloaderMiddleware</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.middlewares.spider_middlewares</span> <span class="kn">import</span> <span class="n">SpiderMiddleware</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.log</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
    <span class="s1">&#39;&#39;&#39;完成对引擎模块的封装&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spider</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        实例化其他的组件，在引起中能够通过调用组件的方法实现功能
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="c1"># self.spider = Spider()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spider</span> <span class="o">=</span> <span class="n">spider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span> <span class="o">=</span> <span class="n">SpiderMiddleware</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span> <span class="o">=</span> <span class="n">DownloaderMiddleware</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        提供引擎启动的入口
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫启动：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_engine</span><span class="p">()</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫结束：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫一共运行：{}秒&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的请求数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的响应数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">start_request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider</span><span class="o">.</span><span class="n">start_requests</span><span class="p">():</span>
            <span class="c1">#1. 对start_request进过爬虫中间件进行处理</span>
            <span class="n">start_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>

            <span class="c1">#2. 调用调度器的add_request方法，添加request对象到调度器中</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
            <span class="c1">#请求数+1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#3. 调用调度器的get_request方法，获取request对象</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1">#如果没有获取到请求对象，直接返回</span>
            <span class="k">return</span>

        <span class="c1">#request对象经过下载器中间件的process_request进行处理</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1">#4. 调用下载器的get_response方法，获取响应</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1">#response对象经过下载器中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1">#response对象经过下爬虫中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1">#5. 调用爬虫的parse方法，处理响应</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="c1">#6.判断结果的类型，如果是request，重新调用调度器的add_request方法</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">Request</span><span class="p">):</span>
                <span class="c1">#在解析函数得到request对象之后，使用process_request进行处理</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#7如果不是，调用pipeline的process_item方法处理结果</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        具体的实现引擎的细节
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_request</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="修改调度器-schedulerpy">修改调度器 <code>scheduler.py</code>：</h4>
<ul>
<li>将从队列获取请求对象设置为非阻塞，否则会造成程序无法退出</li>
<li>统计请求总数，用于判断程序退出</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># scrapy_plus/core/scheduler.py</span>
<span class="s1">&#39;&#39;&#39;调度器模块封装&#39;&#39;&#39;</span>
<span class="c1"># 利用six模块实现py2和py3兼容</span>
<span class="kn">from</span> <span class="nn">six.moves.queue</span> <span class="kn">import</span> <span class="n">Queue</span>


<span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    1. 缓存请求对象(Request)，并为下载器提供请求对象，实现请求的调度
</span><span class="s1">    2. 对请求对象进行去重判断
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="c1"># 记录总共的请求数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_request_number</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;添加请求对象&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_request_number</span> <span class="o">+=</span> <span class="mi">1</span>    <span class="c1"># 统计请求总数</span>

    <span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;获取一个请求对象并返回&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">request</span>

    <span class="k">def</span> <span class="nf">_filter_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;请求去重&#39;&#39;&#39;</span>
        <span class="k">pass</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="爬虫实现多个解析函数">爬虫实现多个解析函数</h2>
<h3 id="响应对象的解析方法封装">响应对象的解析方法封装</h3>
<p>为response对象封装xpath、正则、json、等方法和属性，以支持对数据的解析和提取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/http/response.py</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>


<span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;框架内置Response对象&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>    <span class="c1"># 响应url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>    <span class="c1"># 响应状态码</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>    <span class="c1"># 响应头</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>    <span class="c1"># 响应体</span>

    <span class="k">def</span> <span class="nf">xpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;提供xpath方法&#39;&#39;&#39;</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;提供json解析
</span><span class="s1">        如果content是json字符串，是才有效
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">re_findall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;封装正则的findall方法&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="实现多个解析函数">实现多个解析函数</h3>
<p>由于现在不同的请求对应不同的解析函数，因此需要为请求对象指明它的解析函数，因此为请求对象增加一个属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/http/request.py</span>
<span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;框架内置请求对象，设置请求信息&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="s1">&#39;parse&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>    <span class="c1"># 请求地址</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>    <span class="c1"># 请求方法</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>    <span class="c1"># 请求头</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>    <span class="c1"># 请求参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>    <span class="c1"># 请求体</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span> <span class="o">=</span> <span class="n">parse</span>    <span class="c1"># 指明它的解析函数, 默认是parse方法</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c1"># scrapy_plus/http/response.py</span>
<span class="k">class</span> <span class="nc">Response</span><span class="p">:</span>
    <span class="s1">&#39;&#39;&#39;完成对响应对象的封装&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{}):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        初始化resposne对象
</span><span class="s1">        :param url: 响应的url地址
</span><span class="s1">        :param body: 响应体
</span><span class="s1">        :param headers:  响应头
</span><span class="s1">        :param status_code: 状态码
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="在引擎中需要动态的判断和获取对应的解析函数">在引擎中需要动态的判断和获取对应的解析函数</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">......</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;根据请求、发起请求获取响应、解析响应、处理响应结果&#39;&#39;&#39;</span>

        <span class="o">......</span>

       <span class="c1">#request对象经过下载器中间件的process_request进行处理</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1">#4. 调用下载器的get_response方法，获取响应</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">meta</span>

        <span class="c1">#response对象经过下载器中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1">#response对象经过下爬虫中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1">#parse方法</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spider</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>

        <span class="c1">#5. 调用爬虫的parse方法，处理响应</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="c1">#6.判断结果的类型，如果是request，重新调用调度器的add_request方法</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">Request</span><span class="p">):</span>
                <span class="c1">#在解析函数得到request对象之后，使用process_request进行处理</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#7如果不是，调用pipeline的process_item方法处理结果</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="多爬虫文件">多爬虫文件</h2>
<h3 id="为什么需要优化现有的爬虫结构">为什么需要优化现有的爬虫结构</h3>
<p>当爬虫比较少的时候，我们的项目结构相对合理，但是当要抓取的网站比较多的时候，可以借鉴scrapy的方法，把不同网站的爬虫分别在不同的py文件中编写，之后放在一个目录下；同时，我们很多时候还希望能够有同时启动项目中的所有的爬虫</p>
<h3 id="同时执行多个不同的爬虫">同时执行多个不同的爬虫</h3>
<p>可以将多个爬虫一起启动并执行，传入形式可以使用字典传入多个爬虫</p>
<p>在引擎中用到爬虫对象的地方都要做相应的修改</p>
<p><code>engine.py</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="s1">&#39;&#39;&#39;引擎
</span><span class="s1">a. 对外提供整个的程序的入口
</span><span class="s1">b. 依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="o">......</span>
<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spiders</span><span class="p">):</span>    <span class="c1"># 接收外部传入的多个爬虫对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span> <span class="o">=</span> <span class="n">spiders</span>    <span class="c1"># 爬虫对象</span>

        <span class="o">......</span>

    <span class="o">......</span>

    <span class="k">def</span> <span class="nf">_start_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;向调度器添加初始请求&#39;&#39;&#39;</span>
        <span class="c1"># 1. 爬虫模块发出初始请求</span>
        <span class="k">for</span> <span class="n">spider_name</span><span class="p">,</span> <span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">start_request</span> <span class="ow">in</span> <span class="n">spider</span><span class="o">.</span><span class="n">start_requests</span><span class="p">():</span>
                <span class="c1"># 2. 把初始请求添加给调度器</span>
                <span class="c1"># 利用爬虫中间件预处理请求对象</span>
                <span class="n">start_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="n">start_request</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">spider_name</span>    <span class="c1">#为请求对象绑定它所属的爬虫的名称</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;根据请求、发起请求获取响应、解析响应、处理响应结果&#39;&#39;&#39;</span>

        <span class="o">......</span>

        <span class="n">spider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">spider_name</span><span class="p">]</span>  <span class="c1"># 根据请求的spider_name属性，获取对应的爬虫对象</span>

        <span class="c1"># 5. 利用爬虫的解析响应的方法，处理响应，得到结果</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>    <span class="c1"># 获取对应的解析函数</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>    <span class="c1"># parse函数的返回值是一个容器，如列表或者生成器对象</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
           <span class="c1"># 6. 判断结果对象</span>
           <span class="c1"># 6.1 如果是请求对象，那么就再交给调度器</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
               <span class="c1"># 利用爬虫中间件预处理请求对象</span>
               <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
               <span class="n">result</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">spider_name</span>  <span class="c1"># 为请求对象绑定它所属的爬虫的名称</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
           <span class="c1"># 6.2 否则，就交给管道处理</span>
           <span class="o">......</span>
    <span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><p>安装代码，并运行<code>main.py</code>，直到调试成功</p>
<p>最后将每个爬虫的名称直接设置为爬虫类的一个属性</p>
<h2 id="实现多个管道">实现多个管道</h2>
<h3 id="为什么需要多个管道">为什么需要多个管道</h3>
<p>同爬虫文件一样，不同的爬虫可能需要不同的管道文件，因此管道文件需要在项目中进行实现</p>
<h3 id="项目文件夹中实现管道文件">项目文件夹中实现管道文件</h3>
<p>在项目文件夹下建立pipelines.py文件，不同在于：</p>
<ul>
<li>这里的process_item必须把item对象最后再返回回来，因为是多个管道文件的设置了</li>
<li>需要增加一个参数，也就是传入爬虫对象，以此来判断当前item是属于那个爬虫对象的</li>
</ul>
<h3 id="修改引擎的代码">修改引擎的代码</h3>
<ul>
<li>管道对象将从外部传入</li>
<li>调用管道的process_item方法时，需要遍历出管道</li>
<li>并且需要传递第二个参数，爬虫对象</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="o">......</span>

<span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
    <span class="s1">&#39;&#39;&#39;完成对引擎模块的封装&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spiders</span><span class="p">,</span><span class="n">pipelines</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        实例化其他的组件，在引起中能够通过调用组件的方法实现功能
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="c1"># self.spider = Spider()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span> <span class="o">=</span> <span class="n">spiders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span> <span class="o">=</span> <span class="n">pipelines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span> <span class="o">=</span> <span class="n">SpiderMiddleware</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span> <span class="o">=</span> <span class="n">DownloaderMiddleware</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        提供引擎启动的入口
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫启动：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_engine</span><span class="p">()</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫结束：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫一共运行：{}秒&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的请求数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的响应数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spider_name</span><span class="p">,</span><span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">start_request</span> <span class="ow">in</span> <span class="n">spider</span><span class="o">.</span><span class="n">start_requests</span><span class="p">():</span>
                <span class="c1">#1. 对start_request进过爬虫中间件进行处理</span>
                <span class="n">start_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="n">start_request</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">spider_name</span>

                <span class="c1">#2. 调用调度器的add_request方法，添加request对象到调度器中</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="c1">#请求数+1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#3. 调用调度器的get_request方法，获取request对象</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1">#如果没有获取到请求对象，直接返回</span>
            <span class="k">return</span>

        <span class="c1">#request对象经过下载器中间件的process_request进行处理</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1">#4. 调用下载器的get_response方法，获取响应</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">meta</span>

        <span class="c1">#response对象经过下载器中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1">#response对象经过下爬虫中间件的process_response进行处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1">#parse方法</span>
        <span class="n">spider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">spider_name</span><span class="p">]</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>

        <span class="c1">#5. 调用爬虫的parse方法，处理响应</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="c1">#6.判断结果的类型，如果是request，重新调用调度器的add_request方法</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">Request</span><span class="p">):</span>
                <span class="c1">#在解析函数得到request对象之后，使用process_request进行处理</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">spider_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#7如果不是，调用pipeline的process_item方法处理结果</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">spider</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="修改mainpy">修改<code>main.py</code></h3>
<p>为引擎传入项目中的管道对象</p>
<h2 id="实现项目中传入多个中间件">实现项目中传入多个中间件</h2>
<h3 id="为什么需要多个中间件">为什么需要多个中间件</h3>
<p>不同的中间件可以实现对请求或者是响应对象进行不同的处理，通过不同的中间件实现不同的功能，让逻辑更加清晰</p>
<h3 id="在项目文件夹中创建middlewares文件">在项目文件夹中创建middlewares文件</h3>
<ul>
<li>
<p>项目文件夹中的spider_middlewares.py：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="k">class</span> <span class="nc">TestSpiderMiddleware1</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理请求头，添加默认的user-agent&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestSpiderMiddleware1: process_request&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
  
    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理数据对象&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestSpiderMiddleware1: process_item&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
  
<span class="k">class</span> <span class="nc">TestSpiderMiddleware2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理请求头，添加默认的user-agent&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestSpiderMiddleware2: process_request&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
    
    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理数据对象&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestSpiderMiddleware2: process_item&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>项目文件夹中的downloader_middlewares.py:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="k">class</span> <span class="nc">TestDownloaderMiddleware1</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理请求头，添加默认的user-agent&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestDownloaderMiddleware1: process_request&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
  
    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理数据对象&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestDownloaderMiddleware1: process_response&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
  
<span class="k">class</span> <span class="nc">TestDownloaderMiddleware2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理请求头，添加默认的user-agent&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestDownloaderMiddleware2: process_request&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
  
    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;处理数据对象&#39;&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;TestDownloaderMiddleware2: process_response&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="修改项目文件夹中的mainpy">修改项目文件夹中的<code>main.py</code></h3>
<p>为引擎传入多个中间件</p>
<h3 id="因此相应的的修改enginepy">因此相应的的修改<code>engine.py</code></h3>
<p>改为使用多个中间件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="o">.....</span>

<span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
    <span class="s1">&#39;&#39;&#39;完成对引擎模块的封装&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spiders</span><span class="p">,</span><span class="n">pipelines</span><span class="o">=</span><span class="p">[],</span><span class="n">spider_mids</span><span class="o">=</span><span class="p">[],</span><span class="n">downloader_mids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        实例化其他的组件，在引起中能够通过调用组件的方法实现功能
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="c1"># self.spider = Spider()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span> <span class="o">=</span> <span class="n">spiders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span> <span class="o">=</span> <span class="n">pipelines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span> <span class="o">=</span> <span class="n">spider_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span> <span class="o">=</span> <span class="n">downloader_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        提供引擎启动的入口
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫启动：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_engine</span><span class="p">()</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫结束：{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;爬虫一共运行：{}秒&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的请求数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;总的响应数量:{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spider_name</span><span class="p">,</span><span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">start_request</span> <span class="ow">in</span> <span class="n">spider</span><span class="o">.</span><span class="n">start_requests</span><span class="p">():</span>
                <span class="c1">#1. 对start_request进过爬虫中间件进行处理</span>
                <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
                    <span class="n">start_request</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="n">start_request</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">spider_name</span>

                <span class="c1">#2. 调用调度器的add_request方法，添加request对象到调度器中</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="c1">#请求数+1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#3. 调用调度器的get_request方法，获取request对象</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1">#如果没有获取到请求对象，直接返回</span>
            <span class="k">return</span>

        <span class="c1">#request对象经过下载器中间件的process_request进行处理</span>
        <span class="k">for</span> <span class="n">downloader_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1">#4. 调用下载器的get_response方法，获取响应</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">meta</span>

        <span class="c1">#response对象经过下载器中间件的process_response进行处理</span>
        <span class="k">for</span> <span class="n">downloader_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1">#response对象经过下爬虫中间件的process_response进行处理</span>
        <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1">#parse方法</span>
        <span class="n">spider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">spider_name</span><span class="p">]</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>

        <span class="c1">#5. 调用爬虫的parse方法，处理响应</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="c1">#6.判断结果的类型，如果是request，重新调用调度器的add_request方法</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">Request</span><span class="p">):</span>
                <span class="c1">#在解析函数得到request对象之后，使用process_request进行处理</span>
                <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">spider_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#7如果不是，调用pipeline的process_item方法处理结果</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">spider</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        具体的实现引擎的细节
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_request</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="动态导入模块">动态导入模块</h2>
<h3 id="目前代码存在的问题">目前代码存在的问题</h3>
<p>通过前面的代码编写，我们已经能够完成大部分的任务，但是在<code>main.py</code> 中的代码非常臃肿，对应的我们可以再<code>settings.py</code> 配置哪些爬虫，管道，中间件需要开启，能够让整个代码的逻辑更加清晰</p>
<h3 id="模块动态导入的方法">模块动态导入的方法</h3>
<ul>
<li>利用<code>importlib.import_modle</code>能够传入模块的路径，即可即可实现根据模块的位置的字符串，导入该模块的功能</li>
<li>在项目路径下新建<code>test.py</code>观察现象，插入如下代码观察现象</li>
</ul>
<h3 id="在settings中设置spidermiddlewares">在settings中设置SPIDER，MIDDLEWARES</h3>
<p>利用在配置文件中设置需要启用的爬虫类、管道类、中间件类</p>
<p>利用importlib模块，在引擎中动态导入并实例化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python">  <span class="o">....</span>
  <span class="kn">from</span> <span class="nn">scrapy_plus.conf.settings</span> <span class="kn">import</span> <span class="n">SPIDERS</span><span class="p">,</span> <span class="n">PIPELINES</span><span class="p">,</span> \
      <span class="n">SPIDER_MIDDLEWARES</span><span class="p">,</span><span class="n">DOWNLOADER_MIDDLEWARES</span>

  <span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
      <span class="s1">&#39;&#39;&#39;完成对引擎模块的封装&#39;&#39;&#39;</span>

      <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="s1">&#39;&#39;&#39;
</span><span class="s1">          实例化其他的组件，在引起中能够通过调用组件的方法实现功能
</span><span class="s1">          &#39;&#39;&#39;</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">SPIDERS</span><span class="p">,</span><span class="n">isspider</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">PIPELINES</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">SPIDER_MIDDLEWARES</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">DOWNLOADER_MIDDLEWARES</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">def</span> <span class="nf">_auto_import_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="p">[],</span><span class="n">isspider</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
          <span class="s1">&#39;&#39;&#39;通过配置文件，动态导入类并实例化
</span><span class="s1">          path: 表示配置文件中配置的导入类的路径
</span><span class="s1">          isspider: 由于爬虫需要返回的是一个字典，因此对其做对应的判断和处理
</span><span class="s1">          &#39;&#39;&#39;</span>
          <span class="c1"># 该方法不仅实例化动态导入爬虫，还有管道和中间件，而前者返回应是字典类型</span>
          <span class="k">if</span> <span class="n">isspider</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
              <span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># 存储对应类的实例对象</span>

          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
              <span class="n">module_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># 取出模块名称</span>
              <span class="n">cls_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>    <span class="c1"># 取出类名称</span>
              <span class="n">ret</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>    <span class="c1"># 动态导入爬虫模块</span>
              <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>    <span class="c1"># 根据类名称获取类对象</span>
              <span class="k">if</span> <span class="n">isspider</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                  <span class="n">instances</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">())</span>    <span class="c1"># 实例化类对象</span>
          <span class="k">return</span> <span class="n">instances</span>    <span class="c1"># 返回类对象</span>
  <span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="修改mainpy-1">修改<code>main.py</code></h3>
<p>这样main.py就不用再导入并传入那么多对象了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># project_dir/main.py</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.core.engine</span> <span class="kn">import</span> <span class="n">Engine</span>    <span class="c1"># 导入引擎</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">()</span>  <span class="c1"># 创建引擎对象</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>    <span class="c1"># 启动引擎</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="去重原理">去重原理</h2>
<h3 id="去重的理解">去重的理解</h3>
<p>其实就只是对以往数据进行一个比对，判断是否已经存在</p>
<p>可大致分为：对原始数据比对、对利用原始数据生成的特征值进行比对两种方式</p>
<p>原始数据比对很好理解，就是比对的时候参照值就是原始数据；而利用特征值比对，比如最典型的就是利用原始数据生成一个指纹，比对的参照值就是这个指纹，不是原始数据本身，主要应用于单个原始数据比较大的情况，另外一种常用就是布隆过滤器，这种方式原始利用一种&quot;特征值&rdquo;，应用场景是海量数据的去重(但具有一定几率的误判)。</p>
<h3 id="爬虫请求去重原理和实现">爬虫请求去重原理和实现</h3>
<p>根据请求的url、请求方法、请求参数、请求体进行唯一标识，进行比对，由于这四个数据加到一起，内容较长，因此使用求指纹的方式来进行去重判断。</p>
<p>指纹计算方法，最常用的就是md5、sha1等hash加密算法，来求指纹</p>
<p>具体实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/scheduler.py</span>
<span class="c1"># 利用six模块实现py2和py3兼容</span>
<span class="c1"># coding=utf-8</span>
<span class="c1"># from six.moves.queue import Queue</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.log</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span> <span class="nn">w3lib.url</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.set</span> <span class="kn">import</span> <span class="n">RedisFilterContainer</span><span class="p">,</span><span class="n">NoramlFilterContainer</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.conf.settings</span> <span class="kn">import</span> <span class="n">SCHEDULER_PERSIST</span>


<span class="k">class</span> <span class="nc">Scheduler</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_container</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeate_request_num</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#统计重复的数量</span>

    <span class="k">def</span> <span class="nf">add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_filter_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 去重容器：存储已经发过的请求的特征 url    选用集合类型：set()</span>
        <span class="c1"># 利用请求的url method data  求出一个指纹  利用sha1</span>
        <span class="n">request</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_fp</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">fp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_container</span><span class="o">.</span><span class="n">add_fp</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
            <span class="c1"># logger.info(&#34;添加新的请求：&lt;%s&gt;&#34; % request.url)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;发现重复的请求：&lt;</span><span class="si">%s</span><span class="s2">&gt;&#34;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeate_request_num</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_gen_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;请求去重，计算指纹&#39;&#39;&#39;</span>
        <span class="c1"># 用来判断请求是否重复的属性：url，method，params，data</span>
        <span class="c1"># 为保持唯一性，需要对他们按照同样的排序规则进行排序</span>
        <span class="c1"># 1. url排序：借助w3lib.url模块中的canonicalize_url方法</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">w3lib</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">canonicalize_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># 2. method不需要排序，只要保持大小写一致就可以</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># 4. data排序：如果有提供则是一个字典，如果没有则是空字典</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># 5. 利用sha1算法，计算指纹</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
        <span class="c1"># 为了兼容py2和py3，利用_to_bytes方法，把所有的字符串转化为字节类型</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_bytes</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_bytes</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>

        <span class="n">fp</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fp</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_bytes</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">string</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#如果是python2的unicode类型，转化为字节类型</span>
                <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1">#如果是python3的str类型，转化为字节类型</span>
                <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">string</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="修改engine模块">修改engine模块</h3>
<p>现在统计了总的重复数量，所以，在engine中阻塞的位置判断程序结束的条件：成功的响应数+重复的数量&gt;=总的请求数量程序结束</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#scrapy_plus/core/engine.py</span>
<span class="o">.....</span>
<span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;
</span><span class="s1">        具体的实现引擎的细节
</span><span class="s1">        :return:
</span><span class="s1">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_request</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">()</span>
            <span class="c1">#成功的响应数+重复的数量&gt;=总的请求数量 程序结束</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_nums</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">repeat_request_number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_request_nums</span><span class="p">:</span>
                <span class="k">break</span>
<span class="o">.....</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="利用线程池实现异步">利用线程池实现异步</h2>
<h3 id="异步任务分析">异步任务分析：</h3>
<p>在引擎中，实现的主要功能如下</p>
<ul>
<li>上面的方框中是关于start_urls中的请求处理</li>
<li>下面的方框中是一个请求从调度器取出请求，进行下载之后交给爬虫解析再交给管道的过程 在以上两个过程中，他们之间没有直接的联系，都可以通过异步多线程的方式分别实现，加快程序执行的速度</li>
</ul>
<p>那么具体该如何实现该逻辑</p>
<ul>
<li>multiprocessing.dummy 提供的Pool 类具有apply_async的方法，能够异步的执行让他运行的函数</li>
<li>apply_async方法能够接收一个callback，即其中的函数执行完成之后继续会做的事情，在这里，我们可以定义一个callback，其中让他继续执行上图中下方框的任务，同时给他一个停止条件，</li>
</ul>
<h3 id="利用回调实现循环">利用回调实现循环</h3>
<p>利用回调实现递归，可以达到循环的目的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span>    <span class="c1"># 导入线程池对象</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">scrapy_plus.http.request</span> <span class="kn">import</span> <span class="n">Request</span>    <span class="c1"># 导入Request对象</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.log</span> <span class="kn">import</span> <span class="n">logger</span>    <span class="c1"># 导入logger</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="kn">from</span> <span class="nn">.scheduler</span> <span class="kn">import</span> <span class="n">Scheduler</span>
<span class="kn">from</span> <span class="nn">.downloader</span> <span class="kn">import</span> <span class="n">Downloader</span>


<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    a. 对外提供整个的程序的入口
</span><span class="s1">    b. 依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)
</span><span class="s1">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>    <span class="c1"># 初始化调度器对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span> <span class="o">=</span> <span class="n">Downloader</span><span class="p">()</span>    <span class="c1"># 初始化下载器对象</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SPIDERS</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>  <span class="c1"># 动态导入并实例化爬虫对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PIPELINES</span><span class="p">)</span>  <span class="c1"># 动态导入并实例化管道对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SPIDER_MIDDLEWARES</span><span class="p">)</span>  <span class="c1"># 动态导入并实例化爬虫中间件对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_import_instances</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DOWNLOADER_MIDDLEWARES</span><span class="p">)</span>  <span class="c1"># 动态导入并实例化下载器中间件对象</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>  <span class="c1"># 创建线程池对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># 记录是否退出程序的状态</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;启动整个引擎&#39;&#39;&#39;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="c1"># 起始时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;开始运行时间：</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">start</span><span class="p">)</span>  <span class="c1"># 使用日志记录起始运行时间</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_engine</span><span class="p">()</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="c1"># 结束时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;开始运行时间：</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">stop</span><span class="p">)</span>  <span class="c1"># 使用日志记录结束运行时间</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;耗时：</span><span class="si">%.2f</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>  <span class="c1"># 使用日志记录运行耗时</span>

    <span class="k">def</span> <span class="nf">_start_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;向调度器添加初始请求&#39;&#39;&#39;</span>
        <span class="c1"># 1. 爬虫模块发出初始请求</span>
        <span class="k">for</span> <span class="n">spider_name</span><span class="p">,</span> <span class="n">spider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">start_request</span> <span class="ow">in</span> <span class="n">spider</span><span class="o">.</span><span class="n">start_requests</span><span class="p">():</span>
                <span class="c1"># 2. 把初始请求添加给调度器</span>
                <span class="c1"># 利用爬虫中间件预处理请求对象</span>
                <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
                    <span class="n">start_request</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>
                <span class="n">start_request</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">spider_name</span>  <span class="c1"># 为请求对象绑定它所属的爬虫的名称</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">start_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_request_response_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;根据请求、发起请求获取响应、解析响应、处理响应结果&#39;&#39;&#39;</span>
        <span class="c1"># 3. 从调度器获取请求对象，交给下载器发起请求，获取一个响应对象</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 利用下载器中间件预处理请求对象</span>
        <span class="k">for</span> <span class="n">downloader_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># 4. 利用下载器发起请求</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># 利用下载器中间件预处理响应对象</span>
        <span class="k">for</span> <span class="n">downloader_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloader_mids</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">downloader_mid</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="n">spider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiders</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">spider_name</span><span class="p">]</span>  <span class="c1"># 根据请求的spider_name属性，获取对应的爬虫对象</span>

        <span class="c1"># 5. 利用爬虫的解析响应的方法，处理响应，得到结果</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spider</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>    <span class="c1"># 获取对应的解析函数</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>    <span class="c1"># parse函数的返回值是一个容器，如列表或者生成器对象</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># 6. 判断结果对象</span>
            <span class="c1"># 6.1 如果是请求对象，那么就再交给调度器</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Request</span><span class="p">):</span>
                <span class="c1"># 利用爬虫中间件预处理请求对象</span>
                <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">spider_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">spider_name</span>  <span class="c1"># 为请求对象绑定它所属的爬虫的名称</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="c1"># 6.2 否则，就交给管道处理</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 利用爬虫中间件预处理数据对象</span>
                <span class="k">for</span> <span class="n">spider_mid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spider_mids</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">spider_mid</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>    <span class="c1"># 多个管道对象，轮流处理item对象</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>

        <span class="c1"># 统计响应总数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_response_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;执行新的请求的回调函数，实现循环&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>  <span class="c1"># 如果还没满足退出条件，那么继续添加新任务，否则不继续添加，终止回调函数，达到退出循环的目的</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># 启动引擎，设置状态为True</span>
        <span class="c1"># 向调度器添加初始请求</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_requests</span><span class="p">)</span>  <span class="c1"># 使用异步</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>  <span class="c1"># 利用回调实现循环</span>

        <span class="c1"># 设置循环，处理多个请求</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>  <span class="c1"># 避免cpu空转，消耗性能</span>

            <span class="c1"># 根据请求、发起请求获取响应、解析响应、处理响应结果</span>
            <span class="c1"># self._execute_request_response_item()</span>

            <span class="c1"># 设置退出条件：当请求数和响应数相等时，退出循环</span>
            <span class="c1"># 因为异步，需要增加判断，请求数不能为0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># 满足循环退出条件后，设置运行状态为False</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="实现异步并发控制">实现异步并发控制</h3>
<p>在配置文件中设置最大并发数，并在引擎中使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">......</span>

    <span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="s1">&#39;&#39;&#39;依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)&#39;&#39;&#39;</span>
        <span class="c1"># 向调度器添加初始请求</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_requests</span><span class="p">)</span>    <span class="c1"># 使用异步</span>

        <span class="c1"># 控制最大并发数</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ASYNC_NUMBER</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>    <span class="c1"># 利用回调实现循环</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>    <span class="c1"># 避免cpu空转，消耗性能</span>
            <span class="c1"># 设置退出条件：当请求数和响应数相等时，退出循环</span>
            <span class="c1"># 因为异步，需要增加判断，请求数不能为0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c1"># 满足循环退出条件后，设置运行状态为False</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="对异步任务进行异常控制增加异常回调函数error_callback">对异步任务进行异常控制，增加异常回调函数error_callback</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">......</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;执行新的请求的回调函数，实现循环&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>    <span class="c1"># 如果还没满足退出条件，那么继续添加新任务，否则不继续添加，终止回调函数，达到退出循环的目的</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_error_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;异常回调函数&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span>    <span class="c1"># 抛出异常后，才能被日志进行完整记录下来</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="s1">&#39;&#39;&#39;依次调用其他组件对外提供的接口，实现整个框架的运作(驱动)&#39;&#39;&#39;</span>
        <span class="c1"># 向调度器添加初始请求</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_requests</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">)</span>    <span class="c1"># 使用异步</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_ASYNC_NUMBER</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_request_response_item</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_callback</span><span class="p">)</span>    <span class="c1"># 利用回调实现循环</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>    <span class="c1"># 避免cpu空转，消耗性能</span>
            <span class="c1"># 设置退出条件：当请求数和响应数相等时，退出循环</span>
            <span class="c1"># 因为异步，需要增加判断，请求数不能为0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_response_number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">total_request_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c1"># 满足循环退出条件后，设置运行状态为False</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="使用gevent的pool实现异步并发">使用gevent的Pool实现异步并发</h2>
<h3 id="为什么使用gevent">为什么使用gevent</h3>
<p>对于I/O密集型任务，gevent能对性能做很大提升的，协程的创建、调度开销都比线程小的多。</p>
<h3 id="通过配置文件设置属性来判断所使用的异步方式">通过配置文件设置属性，来判断所使用的异步方式</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># 异步方式  thread、coroutine</span>
<span class="n">ASYNC_TYPE</span> <span class="o">=</span> <span class="s1">&#39;coroutine&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="让gevent的pool和线程池pool的接口一致">让gevent的Pool和线程池Pool的接口一致</h3>
<p>因此需要单独对gevent的Pool进行一下修改，具体如下： 在scrapy_plus下创建async包，随后创建coroutine.py模块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/async/coroutine.py</span>
<span class="s1">&#39;&#39;&#39;
</span><span class="s1">由于gevent的Pool的没有close方法，也没有异常回调参数
</span><span class="s1">引出需要对gevent的Pool进行一些处理，实现与线程池一样接口，实现线程和协程的无缝转换
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">gevent.pool</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">BasePool</span>
<span class="kn">import</span> <span class="nn">gevent.monkey</span>
<span class="n">gevent</span><span class="o">.</span><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>    <span class="c1"># 打补丁，替换内置的模块</span>


<span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">BasePool</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;协程池
</span><span class="s1">    使得具有close方法
</span><span class="s1">    使得apply_async方法具有和线程池一样的接口
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="o">=</span><span class="n">kwds</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;&#39;&#39;什么都不需要执行&#39;&#39;&#39;</span>
        <span class="k">pass</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="在引擎中使用上">在引擎中使用上：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># scrapy_plus/core/engine.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">scrapy_plus.http.request</span> <span class="kn">import</span> <span class="n">Request</span>    <span class="c1"># 导入Request对象</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.utils.log</span> <span class="kn">import</span> <span class="n">logger</span>    <span class="c1"># 导入logger</span>
<span class="kn">from</span> <span class="nn">scrapy_plus.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c1"># 判断使用什么异步模式，改用对应的异步池</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ASYNC_TYPE</span> <span class="o">==</span> <span class="s1">&#39;thread&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span>    <span class="c1"># 导入线程池对象</span>
<span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">ASYNC_TYPE</span> <span class="o">==</span> <span class="s1">&#39;coroutine&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scrapy_plus.async.coroutine</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;不支持的异步类型：</span><span class="si">%s</span><span class="s2">, 只能是&#39;thread&#39;或者&#39;coroutine&#39;&#34;</span><span class="o">%</span><span class="n">settings</span><span class="o">.</span><span class="n">ASYNC_TYPE</span><span class="p">)</span>

<span class="c1"># 注意：</span>
<span class="c1"># 由于打patch补丁是为了替换掉socket为非阻塞的</span>
<span class="c1"># 而下载器中正好使用了requests模块，如果在这之后导入协程池，会导致requests中使用的socket没有被替换成功</span>
<span class="c1"># 从而有可能导致使用出现问题</span>
<span class="kn">from</span> <span class="nn">.scheduler</span> <span class="kn">import</span> <span class="n">Scheduler</span>
<span class="kn">from</span> <span class="nn">.downloader</span> <span class="kn">import</span> <span class="n">Downloader</span>

<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">......</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-06-13</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善" data-hashtags="Python学习之路"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-hashtag="Python学习之路"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://silencehuliang.github.io/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E6%A1%86%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/" data-title="Python学习之路-爬虫提高:框架功能完善"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/">Python学习之路</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E4%B8%80%E4%B8%AApython%E5%BC%80%E5%8F%91%E8%80%85%E5%AF%B9%E9%B8%BF%E8%92%99%E7%9A%84%E7%9C%8B%E6%B3%95/" class="prev" rel="prev" title="一个Python开发者对鸿蒙的看法"><i class="fas fa-angle-left fa-fw"></i>一个Python开发者对鸿蒙的看法</a>
            <a href="/%E6%AF%8F%E5%A4%A9%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84python%E5%BA%93-chardet/" class="next" rel="next" title="每天分享一个Python库-Chardet">每天分享一个Python库-Chardet<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.74.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2018 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Silence</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.4afae7d446ba01ebf7fff19893eaf3a1.css" integrity="md5-Svrn1Ea6Aev3//GYk&#43;rzoQ=="><link rel="stylesheet" href="/lib/katex/copy-tex.min.b1994d1b9785dd8801dbf655df7bf6d9.css" integrity="md5-sZlNG5eF3YgB2/ZV33v22Q=="><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.acf82ee47549fdc386d02768992a49ad.css" integrity="md5-rPgu5HVJ/cOG0CdomSpJrQ=="><script type="text/javascript" src="/lib/valine/Valine.min.b1d2c9b89c70dbf0a8541bfd36afafa1.js" integrity="md5-sdLJuJxw2/CoVBv9Nq&#43;voQ=="></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.100efdceabf7a138f3297e437d078f74.js" integrity="md5-EA79zqv3oTjzKX5DfQePdA=="></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.ae7c5011def46b283696baf367586b5d.js" integrity="md5-rnxQEd70ayg2lrrzZ1hrXQ=="></script><script type="text/javascript" src="/lib/lunr/lunr.min.a08f2562fde4550269dfc13028ed2502.js" integrity="md5-oI8lYv3kVQJp38EwKO0lAg=="></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.b82fb8d93ce0ea6a485dfa3a0b1e7573.js" integrity="md5-uC&#43;42Tzg6mpIXfo6Cx51cw=="></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.f1ba3e22560e2eb7474f28feb4507617.js" integrity="md5-8bo&#43;IlYOLrdHTyj&#43;tFB2Fw=="></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.b80e49640d4794d4333d00db76ea22f7.js" integrity="md5-uA5JZA1HlNQzPQDbduoi9w=="></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.af8ab36589315582ccdd82f22e84bffb.js" integrity="md5-r4qzZYkxVYLM3YLyLoS/&#43;w=="></script><script type="text/javascript" src="/lib/sharer/sharer.min.c3c3372b4cf5c56dd4e5a4be8ada86c9.js" integrity="md5-w8M3K0z1xW3U5aS&#43;itqGyQ=="></script><script type="text/javascript" src="/lib/typeit/typeit.min.b5f3481ebeaa3e56a2f5f96ea648bf69.js" integrity="md5-tfNIHr6qPlai9flupki/aQ=="></script><script type="text/javascript" src="/lib/katex/katex.min.c158c9e823b681cf535f46596b5e4eac.js" integrity="md5-wVjJ6CO2gc9TX0ZZa15OrA=="></script><script type="text/javascript" src="/lib/katex/auto-render.min.28cd0b98cd3f4fa37d52f3ffe47ad9d4.js" integrity="md5-KM0LmM0/T6N9UvP/5HrZ1A=="></script><script type="text/javascript" src="/lib/katex/copy-tex.min.bfaec7d1dea915d74a7a6d833f0ff62e.js" integrity="md5-v67H0d6pFddKem2DPw/2Lg=="></script><script type="text/javascript" src="/lib/katex/mhchem.min.1bbb252363e83547d4b2186a41eaca28.js" integrity="md5-G7slI2PoNUfUshhqQerKKA=="></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.4a48532bf0b17c058b8b6854f49de23f.js" integrity="md5-SkhTK/CxfAWLi2hU9J3iPw=="></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"valine":{"appId":"c4VA4R1Xg3drBKSQzNfWnWlF-gzGzoHsz","appKey":"upEyt7esgWCbm0L7EPDH6bhV","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","meta":["nick","mail"],"pageSize":10,"placeholder":"说点什么吧...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"Silence’s Blog","id-2":"Silence’s Blog"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.7bc7989e979c4a19d97db3ab311a80fe.js" integrity="md5-e8eYnpecShnZfbOrMRqA/g=="></script></body>
</html>
